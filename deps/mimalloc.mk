MIMALLOC_DIR := $(DEPS_DIR)/mimalloc
MIMALLOC_SOURCE_DIR := $(MIMALLOC_DIR)/src
MIMALLOC_INCLUDE_DIR := $(MIMALLOC_DIR)/include

MIMALLOC_SOURCE := $(MIMALLOC_SOURCE_DIR)/static.c
MIMALLOC_OBJECT := $(MIMALLOC_SOURCE:.c=.o)
MIMALLOC_DEPEND := $(MIMALLOC_SOURCE:.c=.d)

MIMALLOC_CC_FLAGS := \
	-I$(MIMALLOC_INCLUDE_DIR) \
	-DMI_XMALLOC=1 -DMI_MALLOC_OVERRIDE=1 -w

ifeq ($(RELEASE), 1)
	MIMALLOC_CC_FLAGS += -DMI_DEBUG=0
else
	MIMALLOC_CC_FLAGS += -DMI_DEBUG=2
endif

$(MIMALLOC_OBJECT): CC_FLAGS += $(MIMALLOC_CC_FLAGS)

$(MIMALLOC_OBJECT): $(MIMALLOC_SOURCE)
	$(PRINT) " CC $(notdir $@)\n"
	$(CC) $(CC_FLAGS) -c -o $@ $<

-include $(MIMALLOC_DEPEND)

.PHONY: clean
clean::
	$(RM) $(RM_FLAGS) $(MIMALLOC_OBJECT) $(MIMALLOC_DEPEND)
